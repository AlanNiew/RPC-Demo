# RPC æ¡†æ¶æ¸è¿›å¼å­¦ä¹ é¡¹ç›®

> ä»é›¶å¼€å§‹ï¼Œä¸€æ­¥æ­¥å®ç°ç”Ÿäº§çº§ RPC æ¡†æ¶

è¿™æ˜¯ä¸€ä¸ªé¢å‘ RPC æ¡†æ¶å­¦ä¹ è€…çš„æ¸è¿›å¼é¡¹ç›®ï¼Œé€šè¿‡ 4 ä¸ªç‰ˆæœ¬çš„è¿­ä»£æ¼”è¿›ï¼Œå±•ç¤ºä»åŸºç¡€ç‰ˆåˆ°ç”Ÿäº§çº§çš„å®Œæ•´å¼€å‘è¿‡ç¨‹ã€‚æ¯ä¸ªç‰ˆæœ¬éƒ½æ˜¯ç‹¬ç«‹å®Œæ•´çš„ï¼Œé€‚åˆå­¦ä¹ è€…é€æ­¥ç†è§£ RPC æ¡†æ¶çš„æ ¸å¿ƒåŸç†å’Œæœ€ä½³å®è·µã€‚

## ğŸ“š é¡¹ç›®ç®€ä»‹

**RPC (Remote Procedure Call)** è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œæ˜¯ä¸€ç§é€šè¿‡ç½‘ç»œä»è¿œç¨‹è®¡ç®—æœºç¨‹åºä¸Šè¯·æ±‚æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œæŠ€æœ¯çš„æ€æƒ³ã€‚

æœ¬é¡¹ç›®é€šè¿‡ 4 ä¸ªç‰ˆæœ¬çš„è¿­ä»£ï¼Œæ¼”ç¤ºäº†å¦‚ä½•ä»é›¶å¼€å§‹å®ç°ä¸€ä¸ªå®Œæ•´çš„ RPC æ¡†æ¶ï¼š

| ç‰ˆæœ¬ | æ ¸å¿ƒç‰¹æ€§ | å­¦ä¹ é‡ç‚¹ |
|------|----------|----------|
| **v1** | åŸºç¡€ç‰ˆ | RPC åŸºæœ¬åŸç†ã€Netty é€šä¿¡ã€åºåˆ—åŒ– |
| **v2** | åŠ¨æ€ä»£ç†ç‰ˆ | JDK åŠ¨æ€ä»£ç†ã€ç®€åŒ–è°ƒç”¨ä½“éªŒ |
| **v3** | æ³¨å†Œä¸­å¿ƒç‰ˆ | æœåŠ¡æ³¨å†Œ/å‘ç°ã€å¿ƒè·³æ£€æµ‹ |
| **v4** | å¤šåºåˆ—åŒ–ç‰ˆ | ç­–ç•¥æ¨¡å¼ã€å·¥å‚æ¨¡å¼ã€å¤šç§åºåˆ—åŒ–æ–¹å¼ |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **JDK**: 17+
- **Maven**: 3.6+
- **IDE**: IDEA / Eclipse

### ç¼–è¯‘é¡¹ç›®

```bash
mvn compile
```

### è¿è¡Œç¤ºä¾‹

#### v1 ç‰ˆæœ¬ - åŸºç¡€ç‰ˆ

```bash
# ç»ˆç«¯ 1: å¯åŠ¨æœåŠ¡ç«¯
mvn exec:java -Dexec.mainClass="com.alan.rpc.v1.demo.ServerMain"

# ç»ˆç«¯ 2: å¯åŠ¨å®¢æˆ·ç«¯
mvn exec:java -Dexec.mainClass="com.alan.rpc.v1.demo.ClientMain"
```

#### v2 ç‰ˆæœ¬ - åŠ¨æ€ä»£ç†ç‰ˆ

```bash
# ç»ˆç«¯ 1: å¯åŠ¨æœåŠ¡ç«¯
mvn exec:java -Dexec.mainClass="com.alan.rpc.v2.demo.ServerMain"

# ç»ˆç«¯ 2: å¯åŠ¨å®¢æˆ·ç«¯
mvn exec:java -Dexec.mainClass="com.alan.rpc.v2.demo.ClientMain"
```

#### v3 ç‰ˆæœ¬ - æ³¨å†Œä¸­å¿ƒç‰ˆ

```bash
# ç»ˆç«¯ 1: å¯åŠ¨æ³¨å†Œä¸­å¿ƒï¼ˆç«¯å£ 9000ï¼‰
mvn exec:java -Dexec.mainClass="com.alan.rpc.v3.demo.RegistryMain"

# ç»ˆç«¯ 2: å¯åŠ¨æœåŠ¡ç«¯ï¼ˆç«¯å£ 8080ï¼‰
mvn exec:java -Dexec.mainClass="com.alan.rpc.v3.demo.ServerMain"

# ç»ˆç«¯ 3: å¯åŠ¨å®¢æˆ·ç«¯
mvn exec:java -Dexec.mainClass="com.alan.rpc.v3.demo.ClientMain"
```

#### v4 ç‰ˆæœ¬ - å¤šåºåˆ—åŒ–ç‰ˆ

```bash
# ç»ˆç«¯ 1: å¯åŠ¨æ³¨å†Œä¸­å¿ƒï¼ˆç«¯å£ 9000ï¼‰
mvn exec:java -Dexec.mainClass="com.alan.rpc.v4.demo.RegistryMain"

# ç»ˆç«¯ 2: å¯åŠ¨æœåŠ¡ç«¯ï¼ˆé»˜è®¤ä½¿ç”¨ JSON åºåˆ—åŒ–ï¼‰
mvn exec:java -Dexec.mainClass="com.alan.rpc.v4.demo.ServerMain"

# ç»ˆç«¯ 3: å¯åŠ¨å®¢æˆ·ç«¯
mvn exec:java -Dexec.mainClass="com.alan.rpc.v4.demo.ClientMain"
```

## ğŸ“– å„ç‰ˆæœ¬è¯¦è§£

### v1 - åŸºç¡€ç‰ˆ

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- å®ç°åŸºæœ¬çš„ RPC è°ƒç”¨æµç¨‹
- ä½¿ç”¨ Netty è¿›è¡Œç½‘ç»œé€šä¿¡
- ä½¿ç”¨ Java åŸç”Ÿåºåˆ—åŒ–

**è°ƒç”¨æ–¹å¼ï¼š**
```java
RpcClient client = new RpcClient("127.0.0.1", 8080);
String result = (String) client.invoke(
    "com.alan.rpc.v1.demo.UserService",  // æ¥å£åç§°
    "getUserName",                        // æ–¹æ³•åç§°
    new Class[]{Integer.class},           // å‚æ•°ç±»å‹
    new Object[]{1001}                    // å‚æ•°å€¼
);
```

**å­¦ä¹ è¦ç‚¹ï¼š**
1. ç†è§£ RPC çš„åŸºæœ¬è°ƒç”¨æµç¨‹
2. äº†è§£ Netty çš„åŸºæœ¬ä½¿ç”¨
3. æŒæ¡ Java åºåˆ—åŒ–æœºåˆ¶
4. ç†è§£ CountDownLatch åŒæ­¥ç­‰å¾…æœºåˆ¶

**åŒ…ç»“æ„ï¼š**
```
com.alan.rpc.v1/
â”œâ”€â”€ common/          # é€šç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ RpcRequest      # RPC è¯·æ±‚å¯¹è±¡
â”‚   â”œâ”€â”€ RpcResponse     # RPC å“åº”å¯¹è±¡
â”‚   â””â”€â”€ Serializer      # åºåˆ—åŒ–å·¥å…·ç±»
â”œâ”€â”€ consumer/        # æœåŠ¡æ¶ˆè´¹è€…
â”‚   â””â”€â”€ RpcClient       # RPC å®¢æˆ·ç«¯
â”œâ”€â”€ provider/        # æœåŠ¡æä¾›è€…
â”‚   â””â”€â”€ RpcServer       # RPC æœåŠ¡ç«¯
â””â”€â”€ demo/            # æ¼”ç¤ºä»£ç 
    â”œâ”€â”€ UserService
    â”œâ”€â”€ UserServiceImpl
    â”œâ”€â”€ ServerMain
    â””â”€â”€ ClientMain
```

---

### v2 - åŠ¨æ€ä»£ç†ç‰ˆ

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ç®€åŒ–è°ƒç”¨
- åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿œç¨‹æœåŠ¡

**è°ƒç”¨æ–¹å¼ï¼š**
```java
RpcClient client = new RpcClient("127.0.0.1", 8080);
UserService userService = client.getProxy(UserService.class);
String result = userService.getUserName(1001);  // åƒæœ¬åœ°è°ƒç”¨ä¸€æ ·ï¼
```

**å­¦ä¹ è¦ç‚¹ï¼š**
1. ç†è§£ JDK åŠ¨æ€ä»£ç†åŸç†
2. æŒæ¡ `Proxy.newProxyInstance()` ä½¿ç”¨
3. ç†è§£ `InvocationHandler` æ‹¦æˆªæœºåˆ¶
4. å­¦ä¹ å¦‚ä½•å°†æ–¹æ³•è°ƒç”¨è½¬æ¢ä¸º RPC è¯·æ±‚

**æ ¸å¿ƒä»£ç ï¼š**
```java
// åˆ›å»ºä»£ç†å¯¹è±¡
public <T> T getProxy(Class<T> interfaceClass) {
    return (T) Proxy.newProxyInstance(
        interfaceClass.getClassLoader(),
        new Class<?>[]{interfaceClass},
        new RpcInvocationHandler(interfaceClass.getName())
    );
}

// æ–¹æ³•æ‹¦æˆªå™¨
private class RpcInvocationHandler implements InvocationHandler {
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) {
        // å°†æ–¹æ³•è°ƒç”¨è½¬æ¢ä¸º RPC è¯·æ±‚
        return RpcClient.this.invoke(
            interfaceName,
            method.getName(),
            method.getParameterTypes(),
            args
        );
    }
}
```

---

### v3 - æ³¨å†Œä¸­å¿ƒç‰ˆ

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- å¼•å…¥æœåŠ¡æ³¨å†Œä¸­å¿ƒ
- æ”¯æŒæœåŠ¡è‡ªåŠ¨æ³¨å†Œå’Œå‘ç°
- å®ç°å¿ƒè·³æ£€æµ‹æœºåˆ¶

**æ¶æ„å›¾ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      æ³¨å†Œ/å‘ç°      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Provider      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   Registry      â”‚
â”‚   (ç«¯å£ 8080)    â”‚                     â”‚   (ç«¯å£ 9000)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–²                                        â”‚
        â”‚                                        â”‚ å‘ç°æœåŠ¡
        â”‚                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Consumer    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   Provider      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      è°ƒç”¨æœåŠ¡        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è°ƒç”¨æµç¨‹ï¼š**
1. Provider å¯åŠ¨æ—¶å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡
2. Consumer è°ƒç”¨å‰ä»æ³¨å†Œä¸­å¿ƒå‘ç°æœåŠ¡å®ä¾‹
3. Provider æ¯ 10 ç§’å‘é€å¿ƒè·³ä¿æŒæ´»è·ƒ
4. æ³¨å†Œä¸­å¿ƒæ¸…ç†è¶…è¿‡ 30 ç§’æ— å¿ƒè·³çš„å®ä¾‹

**å­¦ä¹ è¦ç‚¹ï¼š**
1. ç†è§£æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„åŸç†
2. æŒæ¡ Socket é€šä¿¡æ–¹å¼
3. å­¦ä¹ å¿ƒè·³æ£€æµ‹æœºåˆ¶
4. äº†è§£æœåŠ¡å‘ç°çš„åŸºæœ¬å®ç°

**åè®®æ ¼å¼ï¼š**
```
REGISTER/DISCOVER/HEARTBEAT/DEREGISTER
+ å‚æ•°1 (serviceName)
+ å‚æ•°2 (host/port/instanceId)
```

---

### v4 - å¤šåºåˆ—åŒ–ç‰ˆ

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- æ”¯æŒå¤šç§åºåˆ—åŒ–æ–¹å¼
- ç­–ç•¥æ¨¡å¼ + å·¥å‚æ¨¡å¼
- å¯é…ç½®çš„åºåˆ—åŒ–ç­–ç•¥

**æ”¯æŒçš„åºåˆ—åŒ–æ–¹å¼ï¼š**
| æ–¹å¼ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| Java | åŸç”Ÿæ”¯æŒï¼Œæ— éœ€é¢å¤–ä¾èµ– | å­¦ä¹ ã€æµ‹è¯• |
| JSON | å¯è¯»æ€§å¥½ï¼Œè·¨è¯­è¨€æ”¯æŒå¥½ | è°ƒè¯•ã€å¼‚æ„ç³»ç»Ÿ |
| Hessian | æ€§èƒ½å¥½ï¼ŒäºŒè¿›åˆ¶æ ¼å¼ | ç”Ÿäº§ç¯å¢ƒ |
| Kryo | æ€§èƒ½æœ€ä¼˜ | é«˜æ€§èƒ½åœºæ™¯ |

**ä½¿ç”¨æ–¹å¼ï¼š**
```java
// æŒ‡å®šåºåˆ—åŒ–ç±»å‹
RpcServer server = new RpcServer(8080, "127.0.0.1", 9000, SerializationTypeEnum.JSON);
RpcClient client = new RpcClient("127.0.0.1", 9000, SerializationTypeEnum.JSON);

// æˆ–ä½¿ç”¨å­—ç¬¦ä¸² code
RpcServer server = new RpcServer(8080, "127.0.0.1", 9000, "json");
RpcClient client = new RpcClient("127.0.0.1", 9000, "json");
```

**æ¶æ„è®¾è®¡ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SerializationTypeEnum                  â”‚
â”‚  JAVA | JSON | HESSIAN | KRYO                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ SerializerFactory   â”‚
            â”‚  getSerializer()    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼           â–¼           â–¼
   JavaSerializer JsonSerializer ...
         â”‚           â”‚
         â–¼           â–¼
   serialize()  serialize()
   deserialize() deserialize()
```

**å­¦ä¹ è¦ç‚¹ï¼š**
1. ç†è§£ç­–ç•¥æ¨¡å¼çš„åº”ç”¨
2. æŒæ¡å·¥å‚æ¨¡å¼çš„å®ç°
3. å­¦ä¹ å¦‚ä½•è®¾è®¡å¯æ‰©å±•çš„æ¶æ„
4. äº†è§£ä¸åŒåºåˆ—åŒ–æ–¹å¼çš„ä¼˜ç¼ºç‚¹

## ğŸ”§ æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Java | 17 | å¼€å‘è¯­è¨€ |
| Netty | 4.1.128.Final | ç½‘ç»œé€šä¿¡æ¡†æ¶ |
| Lombok | 1.18.20 | ç®€åŒ–ä»£ç  |
| Jackson | 2.15.2 | JSON åºåˆ—åŒ– (v4) |
| Hessian | 4.0.66 | äºŒè¿›åˆ¶åºåˆ—åŒ– (v4) |
| Kryo | 5.5.0 | é«˜æ€§èƒ½åºåˆ—åŒ– (v4) |

## ğŸ“¦ ç«¯å£ä½¿ç”¨

| ç»„ä»¶ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| RegistryServer | 9000 | æ³¨å†Œä¸­å¿ƒ (v3/v4) |
| RpcServer | 8080 | RPC æœåŠ¡æä¾›è€… |

## ğŸ¯ å­¦ä¹ è·¯å¾„

```
1. v1 åŸºç¡€ç‰ˆ
   â”‚
   â”‚  ç†è§£ RPC åŸºæœ¬åŸç†
   â–¼
2. v2 åŠ¨æ€ä»£ç†ç‰ˆ
   â”‚
   â”‚  å­¦ä¹ å¦‚ä½•ç®€åŒ–è°ƒç”¨
   â–¼
3. v3 æ³¨å†Œä¸­å¿ƒç‰ˆ
   â”‚
   â”‚  ç†è§£æœåŠ¡æ²»ç†
   â–¼
4. v4 å¤šåºåˆ—åŒ–ç‰ˆ
   â”‚
   â”‚  å­¦ä¹ æ¶æ„è®¾è®¡
   â–¼
5. è¿›é˜¶ç‰ˆæœ¬ï¼ˆè®¡åˆ’ä¸­ï¼‰
   - v5: è´Ÿè½½å‡è¡¡ç­–ç•¥
   - v6: é«˜å¯ç”¨ç‰¹æ€§
   - v7: ç”Ÿäº§çº§å®Œæ•´ç‰¹æ€§
```

## ğŸ“ æ ¸å¿ƒæ¦‚å¿µ

### RPC è°ƒç”¨æµç¨‹

```
Consumer                    Provider
   â”‚                           â”‚
   â”‚  1. å‘é€è°ƒç”¨è¯·æ±‚            â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                           â”‚
   â”‚              2. åå°„è°ƒç”¨æœ¬åœ°æ–¹æ³•
   â”‚                           â”‚
   â”‚  3. è¿”å›è°ƒç”¨ç»“æœ            â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                           â”‚
```

### åºåˆ—åŒ–å¯¹æ¯”

| æ–¹å¼ | é€Ÿåº¦ | å¤§å° | å¯è¯»æ€§ | è·¨è¯­è¨€ |
|------|------|------|--------|--------|
| Java | â­â­ | â­â­ | âŒ | âŒ |
| JSON | â­â­â­ | â­â­â­ | âœ… | âœ… |
| Hessian | â­â­â­â­ | â­â­â­â­ | âŒ | âœ… |
| Kryo | â­â­â­â­â­ | â­â­â­â­â­ | âŒ | â­ |

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ‘¨â€ğŸ’» ä½œè€…

Alan

---

**Happy Coding! ğŸ‰**
